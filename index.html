<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OE-BIMS Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-blue: #2563eb; --bg-light: #f3f4f6; --text-dark: #1f2937; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; margin: 0; }
        
        .sidebar { width: 260px; background: white; border-right: 1px solid #ddd; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; display: block; color: gray; text-decoration: none; border-radius: 8px; margin-bottom: 5px;}
        .nav-item.active { background: var(--primary-blue); color: white; }
        
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ddd; }
        .card h2 { font-size: 28px; font-weight: 700; margin: 5px 0 0 0; }
        
        /* TABLES */
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; margin-top: 30px; }
        .table-box { background: white; border-radius: 12px; border: 1px solid #ddd; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f9fafb; font-size: 12px; color: gray; }
        td { padding: 15px; font-size: 14px; border-bottom: 1px solid #eee; }
        
        /* BUTTONS */
        .btn-add { background: var(--primary-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; float: right; }
        .btn-borrow { background: #0ea5e9; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn-return { background: #22c55e; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        
        /* BADGES */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .status-Released { background: #f3e8ff; color: #9333ea; }
        .status-Returned { background: #dcfce7; color: #16a34a; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 350px; }
        input { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: var(--primary-blue); margin-bottom: 40px;">OE-BIMS</h2>
        <a href="#" class="nav-item active">Dashboard</a>
    </div>

    <div class="main-content">
        <button class="btn-add" onclick="openAddModal()">+ Add Item</button>
        <h1>Dashboard</h1>

        <div class="stats-grid">
            <div class="card"><h4>Total Items</h4><h2 id="total-count">0</h2></div>
            <div class="card"><h4>Transactions</h4><h2 id="trans-count">0</h2></div>
        </div>

        <div class="section-title">Equipment Inventory</div>
        <div class="table-box">
            <table>
                <thead><tr><th>Name</th><th>Qty</th><th>Actions</th></tr></thead>
                <tbody id="inventory-list"></tbody>
            </table>
        </div>

        <div class="section-title">Recent Requests</div>
        <div class="table-box">
            <table>
                <thead><tr><th>Equipment</th><th>Borrower</th><th>Purpose</th><th>Status</th><th>Action</th></tr></thead>
                <tbody id="request-list"></tbody>
            </table>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3>Add Equipment</h3>
            <input id="new-name" placeholder="Item Name">
            <input id="new-qty" placeholder="Quantity" type="number">
            <input id="new-price" placeholder="Price" type="number">
            <button class="btn-add" onclick="saveNewItem()">Save</button>
            <button onclick="document.getElementById('addModal').style.display='none'" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <div id="borrowModal" class="modal">
        <div class="modal-content">
            <h3>Borrow Equipment</h3>
            <input id="borrower-name" placeholder="Borrower Name">
            <input id="borrow-purpose" placeholder="Purpose">
            <input type="hidden" id="borrow-id"> <button class="btn-add" onclick="confirmBorrow()">Confirm</button>
            <button onclick="document.getElementById('borrowModal').style.display='none'" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <script>
        const API_URL = ''; // Relative path for cloud

        // --- LOAD DATA ---
        async function refreshData() {
            // 1. Get Inventory
            const resItems = await fetch('/items');
            const items = await resItems.json();
            
            const invList = document.getElementById('inventory-list');
            invList.innerHTML = '';
            let totalQty = 0;

            items.forEach(item => {
                totalQty += item.quantity;
                invList.innerHTML += `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.quantity} units</td>
                        <td>
                            <button class="btn-borrow" onclick="openBorrowModal('${item._id}')">Borrow</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('total-count').innerText = totalQty;

            // 2. Get Transactions
            const resTrans = await fetch('/transactions');
            const transactions = await resTrans.json();
            
            const reqList = document.getElementById('request-list');
            reqList.innerHTML = '';
            document.getElementById('trans-count').innerText = transactions.length;

            transactions.forEach(t => {
                let actionBtn = '';
                if (t.status === 'Released') {
                    actionBtn = `<button class="btn-return" onclick="returnItem('${t._id}')">Return</button>`;
                }

                reqList.innerHTML += `
                    <tr>
                        <td>${t.equipmentName}</td>
                        <td>${t.borrower}</td>
                        <td>${t.purpose}</td>
                        <td><span class="badge status-${t.status}">${t.status}</span></td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });
        }

        // --- ACTIONS ---

        async function saveNewItem() {
            const name = document.getElementById('new-name').value;
            const quantity = document.getElementById('new-qty').value;
            const price = document.getElementById('new-price').value;

            await fetch('/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, quantity, price })
            });
            document.getElementById('addModal').style.display='none';
            refreshData();
        }

        function openBorrowModal(id) {
            document.getElementById('borrow-id').value = id;
            document.getElementById('borrowModal').style.display = 'flex';
        }

        async function confirmBorrow() {
            const itemId = document.getElementById('borrow-id').value;
            const borrower = document.getElementById('borrower-name').value;
            const purpose = document.getElementById('borrow-purpose').value;

            await fetch('/borrow', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ itemId, borrower, purpose })
            });
            document.getElementById('borrowModal').style.display='none';
            refreshData();
        }

        async function returnItem(transId) {
            if(confirm("Confirm return of this item?")) {
                await fetch(`/return/${transId}`, { method: 'POST' });
                refreshData();
            }
        }

        function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }

        // Start
        refreshData();
    </script>
</body>
</html>